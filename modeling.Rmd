---
title: "Predictive Modeling"
output: html_notebook
---

### K-Means Clustering
```{r,warning=FALSE}
qualitydf<-read.csv("qualitydf.csv",header = T)
```

```{r}
# clustering
set.seed(4747)
require(ggplot2)
quality_cluster<-kmeans(qualitydf[,c(1,2)],2)
```

```{r}
# label the cluster
cluster<-quality_cluster$cluster
for(i in 1:length(cluster)){
  if(cluster[i]==2){
    cluster[i]<-"bad"
  }else{
    cluster[i]<-"good"
  }
}
cluster<-as.factor(cluster)
bigdf<-cbind(qualitydf,cluster)

# plot the clustering result
ggplot(bigdf,aes(x=texture,y=profile_resid,shape=as.factor(height),color=cluster))+geom_point()+coord_flip()+theme_classic()
```

## Predictive Modeling

### Feature Extraction
```{r}
# read in the VR measurement matrices 
folder <- "measurements/matrix/"
file_list <- list.files(path = folder, pattern = "*.csv")

mat_pca<-matrix(0,nrow=length(file_list),ncol=1520*1628)
namelst<-list()
for (i in 1:length(file_list)){
    df<- read.csv(paste(folder, file_list[i],sep=''),header=F,skip=23)
    df[is.na(df)]<-0
    #imputedf<-DMwR::knnImputation(df,k=5)
    name<-substr(file_list[i],start=11,stop=nchar(file_list[i])-17)
    namelst<-c(namelst,name)
    if (dim(df)[2]>1628){      # fix a minor issue where one matrix is reversed
      df<-df[1:1520,1:1628]
    }
    if (dim(df)[2]==1520){
      df<-t(df)
    }
    assign(name, df) 
    mat_pca[i,]<-as.vector(as.matrix(df))
    
}
length(file_list)
dim(mat_pca)
```


```{r}
# write the matrices for matlab code of umpca
for (i in 1:dim(mat_pca)[1]){
  mat<-matrix(mat_pca[i,],1520,1628);
  write.csv(mat,paste("umpca_reconstruction/",namelst[i],".csv",sep=''))
}
```

```{r}
# load the umpca components
newfea<-read.csv("umpca_reconstruction/newfea.csv",header=FALSE)
num<-1:dim(newfea)[2]
names(newfea)<-paste("MPC",num,sep='')
```


```{r,echo=FALSE}
# run a pca
dome_pca<-prcomp(mat_pca,center = TRUE)
dome_pca$x[,1:4]
# read the scanner pca
scanner_pca<-read.csv("scanner_pca.csv")[,-1]
colnames(scanner_pca)<-c("scanner_PC1","scanner_PC2","scanner_PC3","scanner_PC4")
```

### Create train and test
```{r}
require(dplyr)
# create the training data frame
pca_df<-data.frame(cbind(dome_pca$x[,1:4],scanner_pca[,1:4],bigdf))
pca_df <- pca_df %>%
  select(-profile_resid,-texture)

# split into train and test by 3:1
# sample 2 from good, 1 from medium and 1 from bad
set.seed(47)
goodind<-sample(which(pca_df$cluster=="good"),2,replace=FALSE)
badind<-sample(which(pca_df$cluster=="bad"),2,replace=FALSE)

testind<-c(goodind,badind)
pca_test<-pca_df[testind,]
pca_train<-pca_df[-testind,]

# create the training df without scanner data
pca_df_no_scanner<-data.frame(cbind(dome_pca$x[,1:4],bigdf))
pca_df_no_scanner <- pca_df_no_scanner %>%
  select(-profile_resid,-texture)

pca_test_no_scanner<-pca_df_no_scanner[testind,]
pca_train_no_scanner<-pca_df_no_scanner[-testind,]
```

```{r}
# create the umpca training data frame
umpca_df<-data.frame(cbind(newfea,scanner_pca,bigdf))
#umpca_df<-data.frame(cbind(scanner_pca,bigdf))
umpca_df <- umpca_df %>%
  select(-profile_resid,-texture)

umpca_test<-umpca_df[testind,]
umpca_train<-umpca_df[-testind,]

# create the training df without scanner data
umpca_df_no_scanner<-data.frame(cbind(newfea,bigdf))
umpca_df_no_scanner <- umpca_df_no_scanner %>%
  select(-profile_resid,-texture)

umpca_test_no_scanner<-umpca_df_no_scanner[testind,]
umpca_train_no_scanner<-umpca_df_no_scanner[-testind,]

```

### Decision Tree
```{r}
# run a decision tree with pca
require(rpart)
require(rpart.plot)
tree<-rpart(cluster~., data = pca_train, method = "class",minsplit=3)
printcp(tree)
rpart.plot(tree)

# predict on the test set
pred<-predict(tree,pca_test,type="class")
confusionMatrix(pred,pca_test$cluster)

# run a decision tree with umpca
tree<-rpart(cluster~., data = umpca_train, method = "class",minsplit=3)
printcp(tree)
rpart.plot(tree)

# predict on the test set
pred<-predict(tree,umpca_test,type="class")
confusionMatrix(pred,umpca_test$cluster)
```

### Random Forest
```{r}
# with pca
control <- trainControl(method="repeatedcv", number=10, repeats=10,verboseIter = FALSE,sampling = "down")
seed <- 47
metric <- "Accuracy"
set.seed(seed)
mtry <- 1:5
tunegrid <- expand.grid(.mtry=mtry)
rf_pca <- train(cluster~., data=pca_train, method="rf", metric=metric, tuneGrid=tunegrid, trControl=control,preProcess = c("scale", "center"))
confusionMatrix(predict(rf_pca,pca_test),pca_test$cluster)
plot(varImp(rf_pca))
rf_pca
```

```{r}
# pca without scanner
set.seed(seed)
rf_pca_no_scanner <- train(cluster~., data=pca_train_no_scanner, method="rf", metric=metric, tuneGrid=tunegrid, trControl=control,preProcess = c("scale", "center"))
confusionMatrix(predict(rf_pca_no_scanner,pca_test_no_scanner),pca_test_no_scanner$cluster)
plot(varImp(rf_pca_no_scanner))
rf_pca_no_scanner
```

```{r}
# with umpca
control <- trainControl(method="repeatedcv", number=10, repeats=10,verboseIter = FALSE,sampling="down")
seed <- 47
metric <- "Accuracy"
set.seed(seed)
mtry <- 1:5
tunegrid <- expand.grid(.mtry=mtry)
rf_umpca <- train(cluster~., data=umpca_train, method="rf", metric=metric, tuneGrid=tunegrid, trControl=control,preProcess = c("scale", "center"))
confusionMatrix(predict(rf_umpca,umpca_test),umpca_test$cluster)
plot(varImp(rf_umpca))
rf_umpca
```

```{r}
# umpca without scanner
control <- trainControl(method="repeatedcv", number=10, repeats=10,verboseIter = FALSE,sampling="down")
seed <- 47
metric <- "Accuracy"
set.seed(seed)
mtry <- 1:5
tunegrid <- expand.grid(.mtry=mtry)
rf_umpca_no_scanner <- train(cluster~., data=umpca_train_no_scanner, method="rf", metric=metric, tuneGrid=tunegrid, trControl=control,preProcess = c("scale", "center"))
confusionMatrix(predict(rf_umpca_no_scanner,umpca_test_no_scanner),umpca_test_no_scanner$cluster)
plot(varImp(rf_umpca_no_scanner))
rf_umpca_no_scanner
```

